[
    {
        "type": "function",
        "function": {
            "name": "get_store_info",
            "description": "Retorna endereço, horários de funcionamento e se o restaurante está aberto agora (is_open_now). Use no início do atendimento ou quando o cliente perguntar se está aberto ou o endereço para retirada.",
            "parameters": {
                "type": "object",
                "additionalProperties": false,
                "properties": {},
                "required": []
            }
        }
    },
    {
        "type": "function",
        "function": {
            "name": "search_product_catalog",
            "description": "Busca produtos no banco (tabela produtos_promo). Sempre use 'category' para filtrar (principal/bebida/adicional) e evitar retorno gigante. 'query' é opcional.",
            "parameters": {
                "type": "object",
                "additionalProperties": false,
                "properties": {
                    "category": {
                        "type": "string",
                        "enum": [
                            "principal",
                            "bebida",
                            "adicional"
                        ],
                        "description": "Categoria obrigatória para filtrar o catálogo."
                    },
                    "query": {
                        "type": "string",
                        "description": "Opcional. Termo de busca (ex: 'coca-cola', 'bacon')."
                    }
                },
                "required": [
                    "category"
                ]
            }
        }
    },
    {
        "type": "function",
        "function": {
            "name": "calculate_cart_total",
            "description": "Calcula subtotal, desconto, frete e total via API interna (/api/order/calculate). Nunca calcule na mão. 'customer_address' pode ser: 'lat,lng', link Google Maps, ou endereço textual derivado do GPS.",
            "parameters": {
                "type": "object",
                "additionalProperties": false,
                "properties": {
                    "items": {
                        "type": "array",
                        "minItems": 1,
                        "items": {
                            "type": "object",
                            "additionalProperties": false,
                            "properties": {
                                "product_id": {
                                    "type": "string"
                                },
                                "quantity": {
                                    "type": "integer",
                                    "minimum": 1
                                }
                            },
                            "required": [
                                "product_id",
                                "quantity"
                            ]
                        }
                    },
                    "cupom_code": {
                        "type": [
                            "string",
                            "null"
                        ],
                        "description": "Opcional. Código do cupom (se existir)."
                    },
                    "customer_address": {
                        "type": "string",
                        "description": "Localização/endereço do cliente. Preferencial: '-23.5505,-46.6333'. Também pode ser link do Google Maps ou texto tipo 'Rua X, nº Y (via GPS)'."
                    }
                },
                "required": [
                    "items",
                    "customer_address"
                ]
            }
        }
    },
    {
        "type": "function",
        "function": {
            "name": "submit_final_order",
            "description": "Registra o pedido na cozinha (insere direto em 'orders'). Só chame quando tiver: items, payment_method, address_number e gps_location (string). Se payment_method='dinheiro', informe change_for (troco).",
            "parameters": {
                "type": "object",
                "additionalProperties": false,
                "properties": {
                    "chat_id": {
                        "type": "string",
                        "description": "Opcional. Se omitido, o handler usa ctx.chat_id."
                    },
                    "items": {
                        "type": "array",
                        "minItems": 1,
                        "items": {
                            "type": "object",
                            "additionalProperties": false,
                            "properties": {
                                "product_id": {
                                    "type": "string"
                                },
                                "quantity": {
                                    "type": "integer",
                                    "minimum": 1
                                }
                            },
                            "required": [
                                "product_id",
                                "quantity"
                            ]
                        }
                    },
                    "subtotal": {
                        "type": "number",
                        "minimum": 0
                    },
                    "discount": {
                        "type": "number",
                        "minimum": 0
                    },
                    "delivery_fee": {
                        "type": "number",
                        "minimum": 0
                    },
                    "total": {
                        "type": "number",
                        "minimum": 0
                    },
                    "payment_method": {
                        "type": "string",
                        "enum": [
                            "pix",
                            "dinheiro",
                            "cartao"
                        ]
                    },
                    "change_for": {
                        "type": [
                            "number",
                            "null"
                        ],
                        "minimum": 0,
                        "description": "Troco para quanto. Obrigatório quando payment_method='dinheiro'. Use null se não for dinheiro."
                    },
                    "address_number": {
                        "type": "string",
                        "description": "Número da residência."
                    },
                    "address_reference": {
                        "type": [
                            "string",
                            "null"
                        ],
                        "description": "Ponto de referência (opcional)."
                    },
                    "gps_location": {
                        "type": "string",
                        "description": "String GPS/endereço derivado. Preferencial: '-23.5505,-46.6333'. Também pode ser link do Google Maps ou 'Rua X, nº Y (via GPS)'."
                    }
                },
                "required": [
                    "items",
                    "subtotal",
                    "total",
                    "payment_method",
                    "address_number",
                    "gps_location"
                ]
            }
        }
    },
    {
        "type": "function",
        "function": {
            "name": "get_pix_payment",
            "description": "Gera cobrança/payload PIX via API interna (/api/order/pix). Use quando payment_method='pix'.",
            "parameters": {
                "type": "object",
                "additionalProperties": false,
                "properties": {
                    "chat_id": {
                        "type": "string",
                        "description": "Opcional. Se omitido, o handler usa ctx.chat_id/ctx.wa_chat_id."
                    },
                    "amount": {
                        "type": "number",
                        "minimum": 0,
                        "description": "Valor total do pedido."
                    }
                },
                "required": [
                    "amount"
                ]
            }
        }
    },
    {
        "type": "function",
        "function": {
            "name": "schedule_proactive_followup",
            "description": "Agenda follow-up (insere em scheduled_messages). Use para abandono, cupom futuro, pós-venda, remarketing.",
            "parameters": {
                "type": "object",
                "additionalProperties": false,
                "properties": {
                    "minutes_delay": {
                        "type": "integer",
                        "minimum": 1,
                        "description": "Minutos para disparar."
                    },
                    "intent": {
                        "type": "string",
                        "enum": [
                            "abandoned_cart",
                            "delayed_coupon",
                            "follow_up",
                            "remarketing"
                        ],
                        "description": "Tipo de follow-up."
                    },
                    "payload": {
                        "type": "object",
                        "additionalProperties": true,
                        "description": "Dados livres para salvar (ex: cupom, preferências, texto sugerido)."
                    }
                },
                "required": [
                    "minutes_delay",
                    "intent"
                ]
            }
        }
    },
    {
        "type": "function",
        "function": {
            "name": "send_uaz_carousel",
            "description": "Retorna JSON de carrossel no formato Uazapi. Use para vitrines e ofertas. Envie 'products' já na ordem correta do banco.",
            "parameters": {
                "type": "object",
                "additionalProperties": false,
                "properties": {
                    "phone": {
                        "type": "string",
                        "description": "Opcional. Se omitido, o handler usa ctx.wa_chat_id."
                    },
                    "products": {
                        "type": "array",
                        "minItems": 1,
                        "items": {
                            "type": "object",
                            "additionalProperties": false,
                            "properties": {
                                "title": {
                                    "type": "string"
                                },
                                "description": {
                                    "type": "string"
                                },
                                "image_url": {
                                    "type": "string",
                                    "format": "uri"
                                },
                                "price": {
                                    "type": "number",
                                    "minimum": 0
                                },
                                "product_id": {
                                    "type": "string",
                                    "description": "ID do produto no banco (usado no buttonId add_to_cart_*)."
                                }
                            },
                            "required": [
                                "title",
                                "description",
                                "image_url",
                                "product_id"
                            ]
                        }
                    }
                },
                "required": [
                    "products"
                ]
            }
        }
    },
    {
        "type": "function",
        "function": {
            "name": "send_uaz_list_menu",
            "description": "Retorna JSON de menu/lista interativa no formato Uazapi. Use para pagamento e escolhas.",
            "parameters": {
                "type": "object",
                "additionalProperties": false,
                "properties": {
                    "phone": {
                        "type": "string",
                        "description": "Opcional. Se omitido, o handler usa ctx.wa_chat_id."
                    },
                    "title": {
                        "type": "string",
                        "description": "Título do menu (ex: 'Pagamento')."
                    },
                    "button_text": {
                        "type": "string",
                        "description": "Texto do botão (ex: 'Ver Opções')."
                    },
                    "description": {
                        "type": "string",
                        "description": "Texto acima das opções."
                    },
                    "sections": {
                        "type": "array",
                        "minItems": 1,
                        "items": {
                            "type": "object",
                            "additionalProperties": false,
                            "properties": {
                                "title": {
                                    "type": "string"
                                },
                                "rows": {
                                    "type": "array",
                                    "minItems": 1,
                                    "items": {
                                        "type": "object",
                                        "additionalProperties": false,
                                        "properties": {
                                            "id": {
                                                "type": "string"
                                            },
                                            "title": {
                                                "type": "string"
                                            },
                                            "description": {
                                                "type": "string"
                                            }
                                        },
                                        "required": [
                                            "id",
                                            "title"
                                        ]
                                    }
                                }
                            },
                            "required": [
                                "title",
                                "rows"
                            ]
                        }
                    }
                },
                "required": [
                    "sections"
                ]
            }
        }
    },
    {
        "type": "function",
        "function": {
            "name": "request_user_location",
            "description": "Retorna payload Uazapi pedindo localização (GPS). Não precisa de args; usa ctx.wa_chat_id.",
            "parameters": {
                "type": "object",
                "additionalProperties": false,
                "properties": {},
                "required": []
            }
        }
    },
    {
        "type": "function",
        "function": {
            "name": "move_kanban_stage",
            "description": "Move o lead no Kanban atualizando stage_id do chat. Usa stage_name (nome exato do estágio no banco).",
            "parameters": {
                "type": "object",
                "additionalProperties": false,
                "properties": {
                    "chat_id": {
                        "type": "string",
                        "description": "Opcional. Se omitido, o handler usa ctx.chat_id."
                    },
                    "stage_name": {
                        "type": "string",
                        "description": "Nome exato do stage (kanban_stages.name), ex: 'Cozinha'."
                    }
                },
                "required": [
                    "stage_name"
                ]
            }
        }
    }
]